## 22. What happens when you type in a url in the brower?

#### Khi bạn nhập địa chỉ 1 trang web vào thanh công cụ trên trình duyệt web:
1. Trình duyệt kiểm tra bộ đệm, nếu đối tượng được yêu cầu có trong bộ đệm và mới, hãy bỏ qua đến # 9
2. Trình duyệt yêu cầu HĐH cho địa chỉ IP của máy chủ
3. HĐH thực hiện tra cứu DNS và trả lời địa chỉ IP cho trình duyệt
4. Trình duyệt mở kết nối TCP đến máy chủ
5. Trình duyệt gửi HTTP request đến máy chủ thông qua kết nối TCP
6. Máy chủ xử lý request và gửi trả lại 1 HTTP response
7. Trình duyệt nhận được HTTP response và có thể đóng kết nối TCP hoặc sử dụng lại cho yêu cầu khác
8. Trình duyệt kiểm tra phản hồi
9. Trình duyệt xác định phải làm gì với phản hồi (ví dụ: có phải là trang HTML không, có phải là hình ảnh không, có phải là clip âm thanh không?)
10. Trình duyệt hiển thị phản hồi hoặc cung cấp hộp thoại cho các loại không được nhận dạng

#### Ví dụ: khi bạn nhập google.com vào hộp địa chỉ trình duyệt của bạn và nhấn enter
1. Phím "g" được nhấn
Phần này sẽ giải thích các hành động của bàn phím vật lý và hành động ngắt của HĐH. Khi bạn nhấn phím "g", trình duyệt sẽ nhận được sự kiện và chức năng tự động hoàn tất sẽ xuật hiện. Tùy thuộc vào thuật toán của trình duyệt và nếu bạn đang ở chế độ riêng tư/ẩn danh thì trình duyệt sẽ đưa ra các đề xuất khác nhau hoặc có thể không có ở bên dưới thanh URL. Hầu hết các thuật toán này sắp xếp và ưu tiên kết qủa dựa trên lịch sử tìm kiếm, các dấu trang, cookie và các tìm kiếm phổ biến từ Internet nói chung. Khi bạn gõ "google,com", các khối code sẽ được chạy và các đề xuất sẽ được thây đổi theo mỗi lần nhấn phím. Trình duyệt còn có thể đề xuất "google.com" trước khi bạn nhập xong.

2. Phím "Enter" được nhấn chạm đáy
Để chọn điểm gốc, hãy chọn phím Enter trên bàn phím được nhấn chạm đáy. Tại thời điểm này, một mạch điện cụ thể cho phím enter được đóng lại (trực tiếp hoặc điện dung). Điều này cho phép một lượng nhỏ dòng điện chạy vào mạch logic của bàn phím, quét trạng thái của từng công tắc phím, tạo ra sự nhiễu điện của việc đóng ngắt liên tục nhanh chóng và chuyển đổi nó thành số nguyên mã khóa, trong trường hợp này 13. Bộ điều khiển bàn phím sau đó mã hóa mã khóa để vận chuyển đến máy tính. Điều này hiện nay gần như phổ biến trên kết nối Universal serial Bus (USB) hoặc Bluetooth, nhưng trong lịch sử đã kết thúc với các kết nối PS/2 hoặc ADB.

- Trong trường hợp bàn phím USB:
	- Mạch USB của bàn phím được cung cấp bởi nguồn 5V được cung cấp qua chân 1 từ bộ điều khiển máy chủ USB của máy tính.
	- Mã khóa được tạo được lưu trữ bởi bộ nhớ mạch bàn phím bên trong trong một thanh ghi gọi là "điểm cuối".
	- Bộ điều khiển USB máy chủ thăm dò ý kiến ​​"điểm cuối" cứ sau ~ 10ms (giá trị tối thiểu được khai báo bởi bàn phím), do đó, nó nhận được giá trị mã khóa được lưu trữ trên thanh ghi.
	- Giá trị này được chuyển đến USB SIE (Serial Interface Engine) để được chuyển đổi trong một hoặc nhiều gói USB tuân theo giao thức USB cấp thấp.
	- Các gói đó được gửi bởi tín hiệu điện vi sai qua các chân D + và D (giữa 2) ở tốc độ tối đa 1,5 Mb/giây, vì một thiết bị HID (Human Interface Device) là "thiết bị tốc độ thấp" (Tuân thủ USB 2.0).
	- Tín hiệu nối tiếp này sau đó được giải mã tại bộ điều khiển USB máy chủ của máy tính và được phiên dịch bởi trình điều khiển thiết bị bàn phím của thiết bị (HID). Giá trị của khóa sau đó được chuyển vào lớp trừu tượng phần cứng của hệ điều hành.


- Trong trường hợp Bàn phím ảo (như trong các thiết bị màn hình cảm ứng):
	- Khi người dùng đặt ngón tay lên màn hình cảm ứng điện dung hiện đại, một lượng nhỏ dòng điện sẽ được chuyển đến ngón tay. Điều này hoàn thành mạch thông qua trường tĩnh điện của lớp dẫn điện và tạo ra sự sụt giảm điện áp tại điểm đó trên màn hình. Sau đó `screen controller` tạo một thông báo gián đoạn tọa độ của phím bấm.
	- Sau đó, HĐH di động thông báo cho ứng dụng hiện tại 'press event' vào một trong các thành phần GUI của nó (mà bây giờ là các nút ứng dụng bàn phím ảo).
	- Bàn phím ảo giờ đây có thể đưa ra một ngắt phần mềm để gửi thông báo 'key pressed' trở lại HĐH.
	- Ngắt này thông báo cho ứng dụng hiện tại sự kiện 'key pressed'.

3. Interrupt fires [không dành cho bàn phím USB]
Bàn phím gửi tín hiệu trên dòng yêu cầu ngắt (IRQ), được ánh xạ tới một interrupt vector (số nguyên) bởi bộ điều khiển ngắt. CPU sử dụng Interrupt Descriptor Table (IDT) để ánh xạ các vectơ ngắt tới các hàm (interrupt handlers) được cung cấp bởi kernel. Khi có một tín hiệu ngắt, CPU lập chỉ mục IDT với vectơ ngắt và chạy trình xử lý thích hợp. Do đó, kernel được nhập vào.

4. (Trên Windows) Một thông báo `WM_KEYDOWN` được gửi đến ứng dụng
HID chuyển sự kiện nhấn phím cho trình điều khiển `KBDHID.sys`, nơi việc sử dụng HID thành một scancode. Trong trường hợp này, mã quét là `VK_RETURN` (0x0D). Trình điều khiển `KBDHID.sys` giao diện với `KBDCLASS.sys` (trình điều khiển lớp bàn phím). Trình điều khiển này chịu trách nhiệm xử lý tất cả các đầu vào bàn phím và keypad một cách an toàn. Sau đó, nó gọi vào `Win32K.sys` (sau khi có khả năng chuyển tin nhắn qua bộ lọc bàn phím của bên thứ 3 được cài đặt). Tất cả điều này xảy ra trong chế độ kernel.

`Win32K.sys` chỉ ra cửa sổ nào là cửa sổ hoạt động thông qua `GetForegroundWindow()` API. API này cung cấp xử lý cửa sổ của hộp địa chỉ của trình duyệt. Windows 'message pump' sau đó gọi `SendMessage(hWnd, WM_KEYDOWN, VK_RETURN, lParam)`. `lParam` là một bitmask cho biết thêm thông tin về phím nhấn: số lần lặp lại (0 trong trường hợp này), mã quét thực tế (có thể phụ thuộc OEM, nhưng thường sẽ không được sử dụng `VK_RETURN`), cho dù là các phím mở rộng (ví dụ: alt, shift, ctrl) cũng được nhấn (nhưng thực tế là không) và một số trạng thái khác.

`SendMessage`API Windows là một hàm đơn giản, thêm thông báo vào hàng đợi cho xử lý cửa sổ cụ thể (`hWnd`). Sau đó, chức năng xử lý thông báo chính (được gọi là a `WindowProc`) gán cho `hWnd` được gọi để xử lý từng thông báo trong hàng đợi.

Cửa sổ (`hWnd`) đang hoạt động thực sự là một điều khiển chỉnh sửa và `WindowProc` trong trường hợp này có trình xử lý thong báo cho `WM_KEYDOWN`. Mã này nằm bên trong tham số thứ 3 được truyền cho `SendMessage` (`wParam`) và vì `VK_RETURN` biết rằng người dùng đã nhấn phím ENTER.

5. (Trên OS X) Một KeyDownNSEvent được gửi đến ứng dụng
Tín hiệu ngắt kích hoạt một sự kiện ngắt trong trình điều khiển bàn phím I/O Kit. Trình điều khiển chuyển tín hiệu thành mã khóa được truyền cho tiến trình `WindowServer` OS X. Kết quả là, `WindowServer` gửi một sự kiện đến bất kỳ ứng dụng thích hợp nào (ví dụ như đang hoạt động hoặc lắng nghe) thông qua cổng Mach của chúng, nơi nó được đặt vào hàng đợi sự kiện. Các sự kiện sau đó có thể được đọc từ hàng đợi này bằng các luồng có đủ đặc quyền gọi hàm `mach_ipc_dispatch`. Điều này thường xảy ra nhất và được xử lý bởi một vòng lặp sự kiện chính `NSApplication`, thông qua `NSEvent` của `NSEventType` `KeyDown`.

6. (Trên GNU / Linux) máy chủ Xorg lắng nghe mã khóa
Khi đồ họa `X server` được sử dụng, `X` sẽ sử dụng trình điều khiển sự kiện chung `evdev` để bết được phím nhấn. Việc ánh xạ lại keycode thành scan code được thực hiện với các keymap và quy tắc `X server` cụ thể. Khi việc ánh xạ scancode của phím được nhấn hoàn tất, `X server` sẽ gửi ký tự đến `window manager` (DWM, metacity, i3, v.v.), do đó đến lượt `window manager` sẽ gửi ký tự đến cửa sổ tập trung. API đồ họa của cửa sổ nhận ký tự in phông chữ phù hợp trong trường tập trung thích hợp.

7. Phân tích cú pháp URL
Trình duyệt bây giờ có các thông tin chứa trong URL (Uniform Resource Locator):
- Protocol "http": Sử dụng 'Giao thức truyền siêu văn bản'
- Resource "/": Truy xuất trang chính (chỉ mục)

8. URL hoặc một thuật ngữ tìm kiếm?
Khi không có giao thức hoặc tên miền hợp lệ nào được đưa ra, trình duyệt sẽ tiến hành cung cấp văn bản trong hộp địa chỉ cho công cụ tìm kiếm web mặc định của trình duyệt. Trong nhiều trường hợp, URL có một đoạn văn bản đặc biệt được thêm vào nó để thông báo cho công cụ tìm kiếm rằng nó đến từ thanh URL của một trình duyệt cụ thể.

9. Chuyển đổi các ký tự Unicode không phải ASCII trong tên máy chủ
- Trình duyệt sẽ kiểm tra tên máy cho các ký tự không có trong `a-z`, `A-Z`, `0-9`, `-`, hoặc `.`.
- Nếu tên máy chủ `google.com` không có